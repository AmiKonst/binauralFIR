!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.createBinauralFIR=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("kdt"),d=function(){"use strict";window.audioContext=window.audioContext||new AudioContext||new webkitAudioContext;var a={hrtfDataset:{writable:!0,value:[]},hrtfDatasetLength:{writable:!0,value:0},tree:{writable:!0,value:-1},position:{writable:!0,value:{}},nextPosition:{writable:!0,value:{}},changeWhenFinishCrossfading:{writable:!0,value:!1},intervalID:{writable:!0},crossfadeDuration:{writable:!0,value:.02},input:{writable:!0},mainConvolver:{writable:!0},secondaryConvolver:{writable:!0},init:{enumerable:!0,value:function(){return this.input=audioContext.createGain(),this.mainConvolver=Object.create({},b),this.mainConvolver.init(),this.mainConvolver.gain.value=1,this.input.connect(this.mainConvolver.input),this.secondaryConvolver=Object.create({},b),this.secondaryConvolver.init(),this.secondaryConvolver.gain.value=0,this.input.connect(this.secondaryConvolver.input),this}},connect:{enumerable:!0,value:function(a){return this.mainConvolver.connect(a),this.secondaryConvolver.connect(a),this}},disconnect:{enumerable:!0,value:function(a){return this.mainConvolver.disconnect(a),this.secondaryConvolver.disconnect(a),this}},HRTFDataset:{enumerable:!0,configurable:!0,set:function(a){this.hrtfDataset=a,this.hrtfDatasetLength=this.hrtfDataset.length;for(var b=0;b<this.hrtfDatasetLength;b++){var d=this.hrtfDataset[b],e=d.azimuth*Math.PI/180,f=d.elevation*Math.PI/180,g=this.sphericalToCartesian(e,f,d.distance);d.x=g.x,d.y=g.y,d.z=g.z}this.tree=c.createKdTree(this.hrtfDataset,this.distance,["x","y","z"])},get:function(){return this.hrtfDataset}},distance:{enumerable:!1,value:function(a,b){return Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2)+Math.pow(a.z-b.z,2)}},setPosition:{enumerable:!0,value:function(a,b,c){if(3===arguments.length||4===arguments.length){var d=this.getRealCoordinates(a,b,c);if(d.azimuth!==this.position.azimuth&&d.elevation!==this.position.elevation&&d.distance!==this.position.distance)return this.isCrossfading()===!0?(this.changeWhenFinishCrossfading===!0?clearInterval(this.intervalID):this.changeWhenFinishCrossfading=!0,this.nextPosition.azimuth=d.azimuth,this.nextPosition.elevation=d.elevation,this.nextPosition.distance=d.distance,this.intervalID=window.setInterval(this.setLastPosition.bind(this),.005)):(this.nextPosition.azimuth=d.azimuth,this.nextPosition.elevation=d.elevation,this.nextPosition.distance=d.distance,this.reallyStartPosition()),this}}},isCrossfading:{enumerable:!1,value:function(){return 1!==this.mainConvolver.gain.value?!0:!1}},reallyStartPosition:{enumerable:!1,value:function(){this.position.azimuth=this.nextPosition.azimuth,this.position.elevation=this.nextPosition.elevation,this.position.distance=this.nextPosition.distance,this.secondaryConvolver.buffer=this.getHRTF(this.position.azimuth,this.position.elevation,this.position.distance),this.crossfading();var a=this.mainConvolver;this.mainConvolver=this.secondaryConvolver,this.secondaryConvolver=a,this.changeWhenFinishCrossfading&&(this.changeWhenFinishCrossfading=!1,clearInterval(this.intervalID))}},setCrossfadeDuration:{enumerable:!0,value:function(a){if(a)return this.crossfadeDuration=a/1e3,this;throw"CrossfadeDuration setting error"}},getCrossfadeDuration:{enumerable:!0,value:function(){return 1e3*this.crossfadeDuration}},getPosition:{enumerable:!0,value:function(){return this.position}},crossfading:{enumerable:!1,value:function(){var a=.02;this.mainConvolver.gain.setValueAtTime(1,audioContext.currentTime+a),this.mainConvolver.gain.linearRampToValueAtTime(0,audioContext.currentTime+a+this.crossfadeDuration),this.secondaryConvolver.gain.setValueAtTime(0,audioContext.currentTime+a),this.secondaryConvolver.gain.linearRampToValueAtTime(1,audioContext.currentTime+a+this.crossfadeDuration)}},getHRTF:{enumerable:!1,value:function(a,b,c){var d=this.getNearestPoint(a,b,c);return d.buffer}},sphericalToCartesian:{enumerable:!1,value:function(a,b,c){return{x:c*Math.sin(a),y:c*Math.cos(a),z:c*Math.sin(b)}}},getRealCoordinates:{enumerable:!1,value:function(a,b,c){var d=this.getNearestPoint(a,b,c);return{azimuth:d.azimuth,elevation:d.elevation,distance:d.distance}}},getNearestPoint:{enumerable:!1,value:function(a,b,c){var d=a*Math.PI/180,e=b*Math.PI/180,f=this.sphericalToCartesian(d,e,c),g=this.tree.nearest(f,1)[0];return g[0]}},setLastPosition:{enumerable:!1,value:function(){this.isCrossfading()||this.reallyStartPosition()}}},b={convNode:{writable:!0},gainNode:{writable:!0},oscillatorNode:{writable:!0},gainOscillatorNode:{writable:!0},init:{enumerable:!0,value:function(){return this.gainNode=audioContext.createGain(),this.convNode=audioContext.createConvolver(),this.convNode.normalize=!1,this.gainNode.connect(this.convNode),this.oscillatorNode=audioContext.createOscillator(),this.gainOscillatorNode=audioContext.createGain(),this.oscillatorNode.connect(this.gainOscillatorNode),this.gainOscillatorNode.connect(this.gainNode),this.gainOscillatorNode.gain.value=0,this.oscillatorNode.start(0),this}},input:{enumerable:!0,get:function(){return this.gainNode}},gain:{enumerable:!0,get:function(){return this.gainNode.gain}},buffer:{enumerable:!0,configurable:!0,set:function(a){this.convNode.buffer=a}},connect:{enumerable:!0,value:function(a){return this.convNode.connect(a),this}},disconnect:{enumerable:!0,value:function(a){return this.convNode.disconnect(a),this}}},d=Object.create({},a);return d.init()};b.exports=d},{kdt:2}],2:[function(a,b){function c(a,b,c){this.obj=a,this.left=null,this.right=null,this.parent=c,this.dimension=b}function d(a,b,d){function f(a,b,e){var g,h,i=b%d.length;return 0===a.length?null:1===a.length?new c(a[0],i,e):(a.sort(function(a,b){return a[d[i]]-b[d[i]]}),g=Math.floor(a.length/2),h=new c(a[g],i,e),h.left=f(a.slice(0,g),b+1,h),h.right=f(a.slice(g+1),b+1,h),h)}var g=this;this.root=f(a,0,null),this.insert=function(a){function b(c,e){if(null===c)return e;var f=d[c.dimension];return a[f]<c.obj[f]?b(c.left,c):b(c.right,c)}var e,f,g=b(this.root,null);return null===g?void(this.root=new c(a,0,null)):(e=new c(a,(g.dimension+1)%d.length,g),f=d[g.dimension],void(a[f]<g.obj[f]?g.left=e:g.right=e))},this.remove=function(a){function b(c){if(null===c)return null;if(c.obj===a)return c;var e=d[c.dimension];return a[e]<c.obj[e]?b(c.left,c):b(c.right,c)}function c(a){function b(a,c){var e,f,g,h,i;return null===a?null:(e=d[c],a.dimension===c?null!==a.right?b(a.right,c):a:(f=a.obj[e],g=b(a.left,c),h=b(a.right,c),i=a,null!==g&&g.obj[e]>f&&(i=g),null!==h&&h.obj[e]>i.obj[e]&&(i=h),i))}function e(a,b){var c,f,g,h,i;return null===a?null:(c=d[b],a.dimension===b?null!==a.left?e(a.left,b):a:(f=a.obj[c],g=e(a.left,b),h=e(a.right,b),i=a,null!==g&&g.obj[c]<f&&(i=g),null!==h&&h.obj[c]<i.obj[c]&&(i=h),i))}var f,h,i;return null===a.left&&null===a.right?null===a.parent?void(g.root=null):(i=d[a.parent.dimension],void(a.obj[i]<a.parent.obj[i]?a.parent.left=null:a.parent.right=null)):(f=null!==a.left?b(a.left,a.dimension):e(a.right,a.dimension),h=f.obj,c(f),void(a.obj=h))}var e;e=b(g.root),null!==e&&c(e)},this.nearest=function(a,c,f){function h(e){function f(a,b){k.push([a,b]),k.size()>c&&k.pop()}var g,i,j,l,m=d[e.dimension],n=b(a,e.obj),o={};for(l=0;l<d.length;l+=1)o[d[l]]=l===e.dimension?a[d[l]]:e.obj[d[l]];return i=b(o,e.obj),null===e.right&&null===e.left?void((k.size()<c||n<k.peek()[1])&&f(e,n)):(g=null===e.right?e.left:null===e.left?e.right:a[m]<e.obj[m]?e.left:e.right,h(g),(k.size()<c||n<k.peek()[1])&&f(e,n),void((k.size()<c||Math.abs(i)<k.peek()[1])&&(j=g===e.left?e.right:e.left,null!==j&&h(j))))}var i,j,k;if(k=new e(function(a){return-a[1]}),f)for(i=0;c>i;i+=1)k.push([null,f]);for(h(g.root),j=[],i=0;c>i;i+=1)k.content[i][0]&&j.push([k.content[i][0].obj,k.content[i][1]]);return j},this.balanceFactor=function(){function a(b){return null===b?0:Math.max(a(b.left),a(b.right))+1}function b(a){return null===a?0:b(a.left)+b(a.right)+1}return a(g.root)/(Math.log(b(g.root))/Math.log(2))}}function e(a){this.content=[],this.scoreFunction=a}e.prototype={push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},peek:function(){return this.content[0]},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]==a){var d=this.content.pop();return void(c!=b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)))}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null;if(b>f){var h=this.content[f],i=this.scoreFunction(h);d>i&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null==g?d:i)>k&&(g=e)}if(null==g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}},b.exports={createKdTree:function(a,b,c){return new d(a,b,c)}}},{}]},{},[1])(1)});